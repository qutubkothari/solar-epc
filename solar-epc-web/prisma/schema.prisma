// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATIONS
  VIEWER
}

enum InquiryStatus {
  NEW
  QUOTED
  APPROVED
  IN_PROGRESS
  CLOSED
}

enum QuotationStatus {
  DRAFT
  FINAL
  APPROVED
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  BLOCKED
}

enum AssetType {
  PANEL
  INVERTER
  OTHER
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      UserRole @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasksAssigned Task[] @relation("AssignedTasks")
  tasksCreated  Task[] @relation("CreatedTasks")
}

model Client {
  id          String   @id @default(cuid())
  name        String
  contactName String?
  email       String?
  phone       String?
  phoneAlt    String?
  mobile      String?
  website     String?
  industry    String?
  companyType String?
  taxId       String? // GST Number for Indian clients
  registrationNo String?
  address     String?
  billingAddress String?
  shippingAddress String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  currency    String?
  creditLimit Decimal?
  paymentTerms String?
  accountManager String?
  status      String? // Lead, Qualified, Quoted, Approved, In Progress, Completed, Lost
  notes       String?
  lastContactDate DateTime?
  nextFollowupDate DateTime?
  followupNotes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inquiries          Inquiry[]
  quotations         Quotation[]
  tokens             TokenAccess[]
  applicationData    ApplicationData[]
  technicalProposals TechnicalProposal[]
}

model Inquiry {
  id          String        @id @default(cuid())
  clientId    String
  title       String
  notes       String?
  siteAddress String?
  status      InquiryStatus @default(NEW)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  client             Client                @relation(fields: [clientId], references: [id])
  media              InquiryMedia[]
  quotations         Quotation[]
  applicationData    ApplicationData[]
  statutoryDocs      StatutoryDocument[]
  executionAssets    ExecutionAsset[]
  completionDocs     CompletionDocument[]
  tasks              Task[]
  tokenAccess        TokenAccess[]
  technicalProposals TechnicalProposal[]
}

model InquiryMedia {
  id        String   @id @default(cuid())
  inquiryId String
  fileName  String
  fileType  String
  fileUrl   String
  createdAt DateTime @default(now())

  inquiry Inquiry @relation(fields: [inquiryId], references: [id])
}

model Item {
  id            String   @id @default(cuid())
  name          String
  description   String?
  brand         String?  // Make/Brand from inventory
  unitPrice     Decimal  @default(0)
  taxPercent    Decimal  @default(0)
  marginPercent Decimal  @default(0)
  uom           String?  // "nos", "meter", "unit", "lot"
  pricingUnit   String?  // "RS/WATT", "Rs/Kw", "PER_UNIT" - for solar EPC pricing
  category      String?
  sku           String?  // Item code/SKU for quick lookup
  isActive      Boolean  @default(true)
  srNo          Int?     // Serial number from PRICE LIST
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quotationItems         QuotationItem[]
  technicalProposalItems TechnicalProposalItem[]
}

model Quotation {
  id             String          @id @default(cuid())
  clientId       String
  inquiryId      String?
  title          String
  status         QuotationStatus @default(DRAFT)
  finalVersionId String?         @unique
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  client             Client              @relation(fields: [clientId], references: [id])
  inquiry            Inquiry?            @relation(fields: [inquiryId], references: [id])
  versions           QuotationVersion[]
  finalVersion       QuotationVersion?   @relation("FinalVersion", fields: [finalVersionId], references: [id])
  technicalProposals TechnicalProposal[]
}

model QuotationVersion {
  id            String   @id @default(cuid())
  quotationId   String
  version       String
  brand         String?
  isFinal       Boolean  @default(false)
  subtotal      Decimal  @default(0)
  taxTotal      Decimal  @default(0)
  marginTotal   Decimal  @default(0)
  grandTotal    Decimal  @default(0)
  createdAt     DateTime @default(now())

  quotation Quotation      @relation(fields: [quotationId], references: [id])
  items     QuotationItem[]
  finalFor  Quotation?      @relation("FinalVersion")
}

model QuotationItem {
  id                 String   @id @default(cuid())
  quotationVersionId String
  itemId             String
  description        String?
  quantity           Decimal  @default(1)
  rate               Decimal  @default(0)
  marginPercent      Decimal  @default(0)
  taxPercent         Decimal  @default(0)
  lineTotal          Decimal  @default(0)

  quotationVersion QuotationVersion @relation(fields: [quotationVersionId], references: [id])
  item            Item             @relation(fields: [itemId], references: [id])
}

model ApplicationData {
  id        String   @id @default(cuid())
  clientId  String
  inquiryId String?
  data      Json
  createdAt DateTime @default(now())

  client  Client   @relation(fields: [clientId], references: [id])
  inquiry Inquiry? @relation(fields: [inquiryId], references: [id])
}

model StatutoryDocument {
  id        String   @id @default(cuid())
  inquiryId String
  name      String
  fileUrl   String
  createdAt DateTime @default(now())

  inquiry Inquiry @relation(fields: [inquiryId], references: [id])
}

model ExecutionAsset {
  id        String   @id @default(cuid())
  inquiryId String
  assetType AssetType
  serialNo  String
  createdAt DateTime @default(now())

  inquiry Inquiry @relation(fields: [inquiryId], references: [id])
}

model TechnicalDataset {
  id          String   @id @default(cuid())
  sourceSheet String
  rowIndex    Int
  data        Json
  createdAt   DateTime @default(now())
}

model QuotationTemplate {
  id          String   @id @default(cuid())
  name        String
  sourceSheet String
  data        Json
  createdAt   DateTime @default(now())
}

model CompletionDocument {
  id        String   @id @default(cuid())
  inquiryId String
  name      String
  fileUrl   String
  createdAt DateTime @default(now())

  inquiry Inquiry @relation(fields: [inquiryId], references: [id])
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(OPEN)
  dueDate     DateTime?
  createdById String
  assignedToId String?
  inquiryId   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  createdBy  User   @relation("CreatedTasks", fields: [createdById], references: [id])
  assignedTo User?  @relation("AssignedTasks", fields: [assignedToId], references: [id])
  inquiry    Inquiry? @relation(fields: [inquiryId], references: [id])
}

model Notification {
  id        String               @id @default(cuid())
  channel   NotificationChannel
  title     String
  message   String
  createdAt DateTime @default(now())
}

model TokenAccess {
  id            String   @id @default(cuid())
  clientId      String
  inquiryId     String
  token         String   @unique
  allowDownload Boolean  @default(true)
  expiresAt     DateTime?
  createdAt     DateTime @default(now())

  client  Client  @relation(fields: [clientId], references: [id])
  inquiry Inquiry @relation(fields: [inquiryId], references: [id])
}

enum ProposalStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

model TechnicalProposal {
  id              String         @id @default(cuid())
  proposalNumber  String         @unique
  clientId        String
  inquiryId       String?
  quotationId     String?
  
  // Proposal Status & Validity
  status          ProposalStatus @default(DRAFT)
  validFrom       DateTime       @default(now())
  validUntil      DateTime?
  
  // Company Details (preparer info)
  preparedBy      String?
  contactPerson   String?
  contactPhone    String?
  contactEmail    String?
  companyName     String?        // Company preparing the proposal
  companyLogo     String?        // Path/URL to company logo for PDF
  
  // Client/Site Details
  siteAddress     String?
  consumerNumber  String?
  consumerType    String?        // Residential, Commercial, Industrial HT/LT
  clientLogo      String?        // Path/URL to client logo for PDF
  
  // Existing Consumption Data
  sanctionedLoad  Decimal?
  contractDemand  Decimal?
  avgMonthlyUnits Decimal?
  avgMonthlyBill  Decimal?
  currentTariff   Decimal?
  
  // Proposed System Specifications
  systemCapacity  Decimal?       // kWp
  annualGeneration Decimal?      // kWh/year
  performanceRatio Decimal?      // %
  degradationRate Decimal?       // % per year
  systemLifespan  Int?           // years
  
  // Equipment Summary (JSON for flexibility)
  panelSpec       Json?          // { brand, model, wattage, quantity, warranty }
  inverterSpec    Json?          // { brand, model, capacity, quantity, warranty }
  structureSpec   Json?          // { type, material, warranty }
  
  // Financial Summary
  systemCost      Decimal?
  subsidyAmount   Decimal?
  netCost         Decimal?
  paybackPeriod   Decimal?       // years
  roi             Decimal?       // %
  savingsYear1    Decimal?
  savings25Year   Decimal?
  
  // Terms & Notes
  executiveNote   String?
  termsConditions String?
  specialNotes    String?
  introText       String?        // Introduction/Executive Summary
  scopeOfWork     String?        // Scope of work description
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  client          Client         @relation(fields: [clientId], references: [id])
  inquiry         Inquiry?       @relation(fields: [inquiryId], references: [id])
  quotation       Quotation?     @relation(fields: [quotationId], references: [id])
  items           TechnicalProposalItem[]
}

model TechnicalProposalItem {
  id                  String            @id @default(cuid())
  technicalProposalId String
  itemId              String
  category            String?           // Panel, Inverter, Structure, Wiring, etc.
  description         String?
  specifications      String?
  quantity            Decimal           @default(1)
  unitPrice           Decimal           @default(0)
  totalPrice          Decimal           @default(0)
  warranty            String?
  brand               String?
  model               String?
  sortOrder           Int               @default(0)

  proposal            TechnicalProposal @relation(fields: [technicalProposalId], references: [id], onDelete: Cascade)
  item                Item              @relation(fields: [itemId], references: [id])
}
